@page "/"
@rendermode InteractiveServer
@using UlanziManagerUI.Services
@inject UlanziManagerService ManagerService
@inject ILogger<Home> Logger
@implements IDisposable

<PageTitle>Ulanzi D200 Manager</PageTitle>

<div class="container-fluid py-4">
    <div class="row">
        <!-- Status Panel -->
        <div class="col-md-4">
            <div class="card shadow mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-activity me-2"></i>Status
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6>Daemon Status</h6>
                        @if (_isDaemonRunning)
                        {
                            <span class="badge bg-success">
                                <i class="bi bi-circle-fill me-1"></i>Läuft
                            </span>
                        }
                        else
                        {
                            <span class="badge bg-secondary">
                                <i class="bi bi-circle-fill me-1"></i>Gestoppt
                            </span>
                        }
                    </div>
                    
                    <div class="mb-3">
                        <h6>Gerät</h6>
                        @if (_deviceStatus?.Connected == true)
                        {
                            <div class="text-success">
                                <i class="bi bi-check-circle me-1"></i>
                                Verbunden: @_deviceStatus.Model
                            </div>
                            <small class="text-muted">Tasten: @_deviceStatus.Buttons</small>
                        }
                        else
                        {
                            <div class="text-danger">
                                <i class="bi bi-x-circle me-1"></i>
                                Nicht verbunden
                            </div>
                        }
                    </div>
                    
                    <div class="d-grid gap-2">
                        @if (_isDaemonRunning)
                        {
                            <button class="btn btn-danger" @onclick="StopDaemon">
                                <i class="bi bi-stop-circle me-2"></i>Daemon stoppen
                            </button>
                        }
                        else
                        {
                            <button class="btn btn-success" @onclick="StartDaemon">
                                <i class="bi bi-play-circle me-2"></i>Daemon starten
                            </button>
                        }
                        
                        <button class="btn btn-primary" @onclick="RefreshStatus">
                            <i class="bi bi-arrow-clockwise me-2"></i>Status aktualisieren
                        </button>
                    </div>
                    
                    @if (!string.IsNullOrEmpty(_statusMessage))
                    {
                        <div class="alert alert-info mt-3 mb-0">
                            @_statusMessage
                        </div>
                    }
                    
                    @if (_validationErrors != null && _validationErrors.Any())
                    {
                        <div class="card mt-3 border-danger">
                            <div class="card-header bg-danger text-white">
                                <i class="bi bi-exclamation-triangle me-2"></i>Validierungsfehler
                            </div>
                            <div class="card-body p-0">
                                <ul class="list-group list-group-flush">
                                    @foreach (var error in _validationErrors)
                                    {
                                        <li class="list-group-item">
                                            <i class="bi bi-x-circle text-danger me-2"></i>
                                            <strong>Button @error.ButtonId:</strong> @error.Message
                                        </li>
                                    }
                                </ul>
                            </div>
                        </div>
                    }
                    
                    @if (_validationSuccess)
                    {
                        <div class="alert alert-success mt-3 mb-0">
                            <i class="bi bi-check-circle me-2"></i>
                            Konfiguration ist gültig! Keine Fehler gefunden.
                        </div>
                    }
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="card shadow">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-lightning me-2"></i>Schnellaktionen
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary" @onclick="ValidateConfig">
                            <i class="bi bi-check2-square me-2"></i>Konfiguration validieren
                        </button>
                        <button class="btn btn-outline-primary" @onclick="ApplyConfig">
                            <i class="bi bi-upload me-2"></i>Konfiguration anwenden
                        </button>
                        <button class="btn btn-outline-secondary" @onclick="OpenConfigFolder">
                            <i class="bi bi-folder2-open me-2"></i>Konfigurationsordner öffnen
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Config Editor -->
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-file-earmark-code me-2"></i>Konfiguration
                    </h5>
                    <div>
                        <button class="btn btn-sm btn-light me-2" @onclick="LoadConfig">
                            <i class="bi bi-arrow-clockwise me-1"></i>Neu laden
                        </button>
                        <button class="btn btn-sm btn-success" @onclick="SaveConfig" disabled="@_isSaving">
                            <i class="bi bi-save me-1"></i>Speichern
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    @if (_configLoaded)
                    {
                        <textarea class="form-control border-0 font-monospace" 
                                  style="min-height: 600px; resize: vertical;"
                                  @bind="_configContent"
                                  @bind:event="oninput"></textarea>
                    }
                    else
                    {
                        <div class="text-center p-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Lädt...</span>
                            </div>
                            <p class="mt-3">Lade Konfiguration...</p>
                        </div>
                    }
                </div>
                <div class="card-footer">
                    <small class="text-muted">
                        <i class="bi bi-info-circle me-1"></i>
                        Konfigurationsdatei: <code>@_configPath</code>
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private bool _isDaemonRunning = false;
    private bool _configLoaded = false;
    private bool _isSaving = false;
    private string _configContent = "";
    private string _configPath = "";
    private string _statusMessage = "";
    private DeviceStatus? _deviceStatus;
    private List<ValidationError>? _validationErrors = null;
    private bool _validationSuccess = false;
    
    protected override async Task OnInitializedAsync()
    {
        ManagerService.OnStatusChanged += HandleStatusChanged;
        ManagerService.OnDeviceStatusChanged += HandleDeviceStatusChanged;
        
        await RefreshStatus();
        await LoadConfig();
    }
    
    private async Task StartDaemon()
    {
        _statusMessage = "Starte Daemon...";
        StateHasChanged();
        
        var success = await ManagerService.StartDaemonAsync();
        if (success)
        {
            _isDaemonRunning = true;
            await Task.Delay(1000);
            await RefreshStatus();
        }
        else
        {
            _statusMessage = "Fehler beim Starten des Daemons";
        }
        
        StateHasChanged();
    }
    
    private async Task StopDaemon()
    {
        _statusMessage = "Stoppe Daemon...";
        StateHasChanged();
        
        var success = await ManagerService.StopDaemonAsync();
        if (success)
        {
            _isDaemonRunning = false;
        }
        
        StateHasChanged();
    }
    
    private async Task RefreshStatus()
    {
        _isDaemonRunning = ManagerService.IsDaemonRunning();
        _deviceStatus = await ManagerService.GetDeviceStatusAsync();
        StateHasChanged();
    }
    
    private async Task LoadConfig()
    {
        _configLoaded = false;
        StateHasChanged();
        
        var config = await ManagerService.LoadConfigAsync();
        if (config != null)
        {
            _configPath = config.ConfigPath;
            _configContent = config.Content;
            _configLoaded = true;
        }
        else
        {
            _statusMessage = "Fehler beim Laden der Konfiguration";
        }
        
        StateHasChanged();
    }
    
    private async Task SaveConfig()
    {
        _isSaving = true;
        StateHasChanged();
        
        var success = await ManagerService.SaveConfigAsync(_configContent);
        if (success)
        {
            _statusMessage = "Konfiguration gespeichert";
        }
        else
        {
            _statusMessage = "Fehler beim Speichern der Konfiguration";
        }
        
        _isSaving = false;
        StateHasChanged();
    }
    
    private async Task ValidateConfig()
    {
        _statusMessage = "Validiere Konfiguration...";
        _validationErrors = null;
        _validationSuccess = false;
        StateHasChanged();
        
        var result = await ManagerService.ValidateConfigWithDetailsAsync();
        
        if (result.IsValid)
        {
            _statusMessage = "";
            _validationSuccess = true;
        }
        else
        {
            _statusMessage = "";
            _validationErrors = result.Errors;
            _validationSuccess = false;
        }
        
        StateHasChanged();
    }
    
    private async Task ApplyConfig()
    {
        _statusMessage = "Wende Konfiguration an...";
        StateHasChanged();
        
        var success = await ManagerService.ApplyConfigAsync();
        
        // Status-Message wird durch HandleStatusChanged vom Service gesetzt
        // Nur setzen falls keine detaillierte Nachricht kam
        if (_statusMessage == "Wende Konfiguration an...")
        {
            _statusMessage = success ? "✓ Konfiguration angewendet" : "✗ Fehler beim Anwenden der Konfiguration";
        }
        
        StateHasChanged();
    }
    
    private void OpenConfigFolder()
    {
        var homeDir = Environment.GetFolderPath(Environment.SpecialFolder.UserProfile);
        var configDir = Path.Combine(homeDir, ".config", "ulanzi");
        
        try
        {
            System.Diagnostics.Process.Start("xdg-open", configDir);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to open config folder");
            _statusMessage = "Fehler beim Öffnen des Ordners";
            StateHasChanged();
        }
    }
    
    private void HandleStatusChanged(string message)
    {
        _statusMessage = message;
        InvokeAsync(StateHasChanged);
    }
    
    private void HandleDeviceStatusChanged(DeviceStatus status)
    {
        _deviceStatus = status;
        InvokeAsync(StateHasChanged);
    }
    
    public void Dispose()
    {
        ManagerService.OnStatusChanged -= HandleStatusChanged;
        ManagerService.OnDeviceStatusChanged -= HandleDeviceStatusChanged;
    }
}
